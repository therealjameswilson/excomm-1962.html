<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ExComm: October 1962 — FRUS Game (Autoload + Rich Evidence)</title>
<link rel="preconnect" href="https://unpkg.com" />
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html,body,#root{height:100%}
  body{background:linear-gradient(#f8fafc,#eef2f7)}
  .leaflet-container{border-radius:1rem}
  .card{border-radius:1rem;border:1px solid rgba(0,0,0,.06);background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.06)}
</style>
</head>
<body>
<div id="root" class="p-4 md:p-8"></div>

<script type="text/babel">
// --- Utilities ---
const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
const cn=(...xs)=>xs.filter(Boolean).join(" ");

// --- WebAudio synth cues ---
function useAudio(){
  const ctxRef=React.useRef(null);
  const [enabled,setEnabled]=React.useState(true);
  function ensure(){ if(!ctxRef.current){ const Ctx=window.AudioContext||window.webkitAudioContext; if(Ctx) ctxRef.current=new Ctx(); } return ctxRef.current; }
  function play(kind){
    if(!enabled) return;
    const ctx=ensure(); if(!ctx) return; const t=ctx.currentTime;
    const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g).connect(ctx.destination);
    g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.4,t+0.01);
    let dur=0.18,f1=440,f2=660,typ="sine";
    if(kind==="decision"){f1=520;f2=620;dur=0.12;typ="triangle";}
    else if(kind==="tension"){f1=180;f2=140;dur=0.35;typ="sawtooth";}
    else if(kind==="success"){f1=660;f2=880;dur=0.25;typ="square";}
    else if(kind==="epilogue"){f1=392;f2=523.25;dur=0.5;typ="sine";}
    o.type=typ; o.frequency.setValueAtTime(f1,t); o.frequency.linearRampToValueAtTime(f2,t+dur);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.start(t); o.stop(t+dur+0.02);
  }
  return {enabled,toggle:()=>setEnabled(e=>!e),play};
}

// --- TEI parsing (rich) ---
function computeKeywords(text){
  const K=["Cuba","Cuban","missile","SAM","SA-2","Khrushchev","Dobrynin","U-2","quarantine","blockade","OAS","Turkey","Jupiter","Berlin","Castro","air strike","invasion","UN","no invasion","nuclear","Soviet","USSR","ExComm","Rusk","McNamara","Bundy"];
  const t=(text||"").toLowerCase(); const out=new Set(); K.forEach(k=>{ if(t.includes(k.toLowerCase())) out.add(k); }); return [...out];
}
function parseTEIXML(xmlText){
  try{
    const xml=new DOMParser().parseFromString(xmlText,"text/xml");
    const divs=[...xml.querySelectorAll("div[type='document']")];
    return divs.map((div,i)=>{
      const id=div.getAttribute("xml:id")||"doc_"+i;
      const head=(div.querySelector("head")?.textContent||"Untitled FRUS Document").trim().replace(/\s+/g," ");
      let dateISO,dateText;
      const dateEl=div.querySelector("opener dateline date");
      if(dateEl){ dateText=dateEl.textContent?.trim(); const when=dateEl.getAttribute("when")||dateEl.getAttribute("notBefore")||dateEl.getAttribute("notAfter"); if(when) dateISO=when.slice(0,10); }
      if(!dateISO){ const min=div.getAttribute("frus:doc-dateTime-min"); if(min) dateISO=min.slice(0,10); }
      const place=div.querySelector("opener dateline placeName")?.textContent?.trim();
      const firstP=div.querySelector("p");
      const summary=firstP? (firstP.textContent||"").trim().replace(/\s+/g," ").slice(0,300)+(((firstP.textContent||"").length>300)?"…":""):undefined;
      const flat=(div.textContent||"").replace(/\s+/g," ");
      const keywords=computeKeywords(flat);
      return {id,head,dateISO,dateText,place,summary,keywords};
    });
  }catch(e){ console.error(e); return []; }
}

// --- Turns (same as before; abbreviated for brevity) ---
const TURNS=[
  {id:"1962-10-16_initial",date:"1962-10-16",title:"Briefing: Missiles in Cuba",scene:"CIA U-2 photos indicate MRBM sites under construction in Cuba. The President convenes the ExComm.",prompt:"What initial course do you recommend while options are evaluated?",evidenceHints:["Cuba","missile","SAM","U-2","Soviet"],options:[
    {id:"recon_delay",label:"Quietly expand reconnaissance and delay public move",rationale:"Buying time reduces miscalculation; better intelligence supports calibrated options.",effect:s=>({...s,cs:clamp(s.cs+5,0,100),er:clamp(s.er-2,0,100)})},
    {id:"air_strike_signal",label:"Prepare a limited air strike option immediately",rationale:"Readiness may deter, but preparations risk detection and Soviet/Cuban pre-emption.",effect:s=>({...s,cs:clamp(s.cs-2,0,100),er:clamp(s.er+6,0,100)})},
    {id:"announce_now",label:"Announce the discovery publicly right away",rationale:"Transparency rallies allies, but could corner both sides before options are weighed.",effect:s=>({...s,cs:clamp(s.cs-1,0,100),er:clamp(s.er+4,0,100)})},
  ]},
  {id:"1962-10-20_course",date:"1962-10-20",title:"Choosing a Course",scene:"Debate narrows to a surprise air strike vs. a naval quarantine (blockade).",prompt:"Which option do you back?",evidenceHints:["quarantine","OAS","air strike","invasion","Khrushchev"],options:[
    {id:"quarantine",label:"Support a naval quarantine with OAS backing",rationale:"Signals resolve while leaving space for diplomacy; allied backing matters at the UN and OAS.",effect:s=>({...s,cs:clamp(s.cs+8,0,100),er:clamp(s.er-5,0,100)})},
    {id:"air_strike",label:"Support immediate air strikes on missile sites",rationale:"Removes missiles quickly but risks a rapid escalation including Berlin.",effect:s=>({...s,cs:clamp(s.cs-6,0,100),er:clamp(s.er+10,0,100)})},
  ]},
  {id:"1962-10-26_letters",date:"1962-10-26",title:"Two Letters from Moscow",scene:"A conciliatory private letter is followed by a tougher public letter linking removal to Turkish Jupiters.",prompt:"What negotiating line do you recommend?",evidenceHints:["Khrushchev","letter","Turkey","Jupiter","no invasion"],options:[
    {id:"reply_first_letter",label:"Reply to the first (private) letter and ignore the second",rationale:"Keeps talks on the more flexible track; avoids public linkage to NATO equities.",effect:s=>({...s,cs:clamp(s.cs+7,0,100),er:clamp(s.er-3,0,100)})},
    {id:"package_deal",label:"Acknowledge both; explore a quiet Jupiter trade",rationale:"Risks alliance blowback but might unlock a quick settlement if sequenced and kept private.",effect:s=>({...s,cs:clamp(s.cs+3,0,100),er:clamp(s.er-1,0,100)})},
    {id:"reject_linkage",label:"Reject linkage to Turkey; harden stance",rationale:"Protects NATO but increases chances of collision at sea and in Cuba.",effect:s=>({...s,cs:clamp(s.cs-3,0,100),er:clamp(s.er+6,0,100)})},
  ]},
  {id:"1962-10-27_black_saturday",date:"1962-10-27",title:"Black Saturday",scene:"A U-2 is shot down over Cuba; tensions spike.",prompt:"How do you recommend responding to the shoot-down?",evidenceHints:["U-2","SAM","SA-2","shoot down","quarantine"],options:[
    {id:"hold_fire",label:"Hold fire; keep quarantine; push urgent backchannel",rationale:"Avoids tit-for-tat that could unravel diplomacy during decisive hours.",effect:s=>({...s,cs:clamp(s.cs+9,0,100),er:clamp(s.er-8,0,100)})},
    {id:"strike_sam",label:"Immediate strike on the offending SAM site",rationale:"Punishes aggression but risks direct combat and escalation.",effect:s=>({...s,cs:clamp(s.cs-8,0,100),er:clamp(s.er+12,0,100)})},
  ]},
  {id:"1962-10-28_settlement",date:"1962-10-28",title:"Settlement?",scene:"Moscow signals willingness to remove missiles with UN verification and a U.S. no-invasion pledge; a quiet Jupiter assurance circulates.",prompt:"What final guidance do you give?",evidenceHints:["UN","no invasion","verification","Turkey","Jupiter"],options:[
    {id:"accept_core",label:"Accept the core deal; keep any Jupiter understanding private and later",rationale:"Locks in removal and preserves alliance cohesion via sequencing.",effect:s=>({...s,cs:clamp(s.cs+10,0,100),er:clamp(s.er-10,0,100)})},
    {id:"demand_more",label:"Demand additional concessions now",rationale:"Ambitious asks risk unraveling momentum at the finish line.",effect:s=>({...s,cs:clamp(s.cs-2,0,100),er:clamp(s.er+5,0,100)})},
  ]},
];

// --- Sites for map ---
const SITES=[
  {id:"dc",name:"White House / ExComm",lat:38.8977,lng:-77.0365,tags:["US","Exec"]},
  {id:"un",name:"United Nations (NYC)",lat:40.7499,lng:-73.9680,tags:["UN","diplomacy"]},
  {id:"havana",name:"Havana",lat:23.1136,lng:-82.3666,tags:["Cuba"]},
  {id:"sancristobal",name:"San Cristóbal area (MRBM)",lat:22.7167,lng:-83.0500,tags:["Cuba","missile"]},
  {id:"sagua",name:"Sagua la Grande area (MRBM)",lat:22.8067,lng:-80.0750,tags:["Cuba","missile"]},
  {id:"guanajay",name:"Guanajay area (IRBM)",lat:22.9269,lng:-82.6883,tags:["Cuba","missile"]},
  {id:"banes",name:"Banes area (SAM/U-2)",lat:20.9600,lng:-75.7219,tags:["Cuba","SAM","U-2"]},
  {id:"turkey",name:"Jupiter sites (Turkey, approx)",lat:38.4189,lng:27.1287,tags:["Turkey","Jupiter"]},
  {id:"moscow",name:"Moscow",lat:55.7558,lng:37.6173,tags:["USSR","Khrushchev"]},
];
function sitesForTurn(turn){
  if(!turn) return SITES.filter(s=>s.id==="dc"||s.id==="havana");
  const hits=new Set();
  (turn.evidenceHints||[]).forEach(h=>{ SITES.forEach(s=>{ if(s.tags.some(t=>t.toLowerCase()===h.toLowerCase())) hits.add(s.id); }); });
  hits.add("dc"); hits.add("havana");
  return SITES.filter(s=>hits.has(s.id));
}

// --- Small atoms ---
const Pill=({children})=><span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium">{children}</span>;
const Card=({children,className})=><div className={cn("card p-4 md:p-6 bg-white/90 backdrop-blur",className)}>{children}</div>;
const Button=({children,onClick,variant="primary",disabled})=>(
  <button onClick={onClick} disabled={disabled}
    className={cn("rounded-2xl px-4 py-2 font-semibold shadow-sm transition",
      disabled?"opacity-60 cursor-not-allowed":"hover:scale-[1.01]",
      variant==="primary"&&"bg-black text-white", variant==="ghost"&&"bg-transparent border")}>{children}</button>
);

// --- Evidence Drawer (rich) ---
function EvidenceDrawer({docs}){
  const [open,setOpen]=React.useState(false);
  const [q,setQ]=React.useState("");
  const filtered=React.useMemo(()=>{
    if(!open) return [];
    if(!q.trim()) return docs||[];
    const s=q.toLowerCase();
    return (docs||[]).filter(d=>
      (d.head||"").toLowerCase().includes(s) ||
      (d.summary||"").toLowerCase().includes(s) ||
      (d.place||"").toLowerCase().includes(s) ||
      ((d.dateISO||d.dateText||"").toLowerCase().includes(s)) ||
      (d.keywords||[]).join(" ").toLowerCase().includes(s)
    ).slice(0,60);
  },[open,q,docs]);
  return <Card>
    <button className="text-sm underline underline-offset-4" onClick={()=>setOpen(v=>!v)}>{open?"Hide Evidence":`Open Evidence (${docs?.length||0})`}</button>
    {open&&<div className="mt-3 space-y-3">
      <input className="w-full rounded-2xl border px-3 py-2" placeholder="Search titles, places, summaries, keywords" value={q} onChange={e=>setQ(e.target.value)} />
      <div className="grid gap-3 md:grid-cols-2">
        {(filtered||[]).map(d=>(<Card key={d.id}>
          <div className="text-xs text-slate-500">{d.dateISO||d.dateText||"(undated)"}{d.place?` — ${d.place}`:""}</div>
          <div className="font-semibold">{d.head}</div>
          {d.keywords?.length?<div className="mt-1 text-xs text-slate-500">Keywords: {(d.keywords||[]).join(", ")}</div>:null}
          {d.summary?<p className="mt-1 text-sm text-slate-700">{d.summary}</p>:null}
        </Card>))}
      </div>
    </div>}
  </Card>;
}

// --- Leaflet Map (imperative, CDN) ---
function MapPanel({sites}){
  const ref=React.useRef(null);
  React.useEffect(()=>{
    let map,layer;
    function ensure(){ if(window.L) return Promise.resolve(); return new Promise(res=>{
      const s=document.querySelector('script[src*="leaflet"]'); if(s){ s.addEventListener('load',()=>res()); return; } res(); }); }
    ensure().then(()=>{
      const L=window.L; if(!L||!ref.current) return;
      map=L.map(ref.current,{center:[23.5,-80],zoom:5,scrollWheelZoom:false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
      layer=L.layerGroup().addTo(map);
      draw();
    });
    function draw(){
      if(!window.L||!layer) return; layer.clearLayers();
      const bounds=[]; (sites||[]).forEach(s=>{ const m=window.L.marker([s.lat,s.lng]).bindPopup('<strong>'+s.name+'</strong>'); m.addTo(layer); bounds.push([s.lat,s.lng]); });
      if(bounds.length) try{ layer._map.fitBounds(bounds,{padding:[20,20]}); }catch(e){}
    }
    return ()=>{ try{ map&&map.remove(); }catch(e){} };
  },[JSON.stringify(sites)]);
  return <Card><div className="text-sm font-semibold mb-2">Map — Key Crisis Sites</div><div ref={ref} className="h-80 w-full rounded-2xl" /></Card>;
}

// --- Game ---
function Game(){
  const audio=useAudio();
  const [phase,setPhase]=React.useState("start");
  const [player,setPlayer]=React.useState("");
  const [docs,setDocs]=React.useState([]);
  const [showMap,setShowMap]=React.useState(true);
  const [state,setState]=React.useState({playerName:"",cs:50,er:50,dayIndex:0,log:[],ended:false,ending:undefined});

  // AUTOLOAD the XML from the same directory
  React.useEffect(()=>{
    let cancelled=false;
    async function loadXML(){
      try{
        const res=await fetch("./October-1962.xq.xml",{cache:"reload"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const txt=await res.text();
        const parsed=parseTEIXML(txt);
        if(!cancelled){ setDocs(parsed); console.log("Loaded FRUS docs:", parsed.length); }
      }catch(err){
        console.warn("Autoload failed; no evidence loaded.", err);
      }
    }
    loadXML();
    return ()=>{ cancelled=true; };
  },[]);

  const turn=TURNS[state.dayIndex];
  const evidence=React.useMemo(()=>{
    if(!turn) return [];
    const target=turn.date?new Date(turn.date).getTime():null;
    const scored=(docs||[]).map(d=>{
      const time=d.dateISO?new Date(d.dateISO).getTime():NaN;
      const dt=isNaN(time)||target===null?0:Math.max(0,1-Math.abs(time-target)/(1000*3600*24*14));
      const kw = (turn.evidenceHints||[]).reduce((n,h)=> n + ((d.keywords||[]).includes(h)?1:0), 0);
      return {d,score:dt+kw*0.5};
    });
    return scored.filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,6).map(x=>x.d);
  },[docs,turn]);

  function begin(){ if(!player.trim()) return; setState(s=>({...s,playerName:player})); audio.play("decision"); setPhase("turn"); }
  function chooseDummy(){ audio.play("decision"); setPhase("epilogue"); }

  return <div className="mx-auto max-w-5xl space-y-6">
    <header className="flex items-center justify-between flex-wrap gap-3">
      <h1 className="text-2xl md:text-3xl font-extrabold tracking-tight">ExComm: October 1962 — A FRUS-Based Simulation</h1>
      <div className="flex items-center gap-2 text-sm">
        <Pill>Audio: <button className="underline" onClick={()=>audio.toggle()}>{audio.enabled?"on":"off"}</button></Pill>
        <Pill>Map: <button className="underline" onClick={()=>setShowMap(v=>!v)}>{showMap?"on":"off"}</button></Pill>
      </div>
    </header>

    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      <Card>
        <div className="text-sm text-slate-600">Crisis Stability</div>
        <div className="mt-2 h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div className="h-3 bg-green-600" style={{width: "50%"}} /></div>
        <div className="mt-1 text-xs">50/100</div>
      </Card>
      <Card>
        <div className="text-sm text-slate-600">Escalation Risk</div>
        <div className="mt-2 h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div className="h-3 bg-red-600" style={{width: "50%"}} /></div>
        <div className="mt-1 text-xs">50/100</div>
      </Card>
      <Card>
        <div className="text-sm text-slate-600">Player</div>
        <div className="mt-1 font-semibold">{player||"—"}</div>
        <div className="text-xs text-slate-500">ExComm staff officer</div>
      </Card>
    </div>

    {phase==="start"&&<Card className="space-y-4">
      <p className="text-slate-700">You are a fictitious member of the National Security Council, present for key ExComm meetings during October 1962. Your job: synthesize intelligence, advise principals, and keep the world out of a war.</p>
      <div className="flex flex-col sm:flex-row gap-3 items-center">
        <input className="w-full sm:w-80 rounded-2xl border px-3 py-2" placeholder="Enter your name" value={player} onChange={e=>setPlayer(e.target.value)} />
        <Button onClick={begin} disabled={!player.trim()}>Begin</Button>
      </div>
      <EvidenceDrawer docs={docs} />
    </Card>}

    {phase==="turn"&&turn&&<>
      <Card className="space-y-3">
        <div className="text-xs text-slate-500">{turn.date}</div>
        <h2 className="text-xl font-bold">{turn.title}</h2>
        <p className="text-slate-700">{turn.scene}</p>

        <div className="grid gap-3 md:grid-cols-2 mt-3">
          {turn.options.map(opt=>(<Card key={opt.id} className="border-dashed">
            <div className="font-semibold">{opt.label}</div>
            <div className="mt-1 text-sm text-slate-600">{opt.rationale}</div>
            <div className="mt-3"><Button onClick={chooseDummy}>Choose</Button></div>
          </Card>))}
        </div>

        <div className="mt-4 grid gap-4 md:grid-cols-2">
          <EvidenceDrawer docs={evidence} />
          {showMap && <MapPanel sites={sitesForTurn(turn)} />}
        </div>
      </Card>
    </>}

    {phase==="epilogue"&&<Card className="space-y-4">
      <h2 className="text-xl font-bold">Epilogue</h2>
      <p className="text-slate-700">Demo ending (wire to your full scoring logic as desired).</p>
      <div className="flex gap-3">
        <Button onClick={()=>{location.reload();}}>Play again</Button>
      </div>
    </Card>}
  </div>;
}

// Mount
const root=ReactDOM.createRoot(document.getElementById("root"));
root.render(<Game/>);
</script>
</body>
</html>
